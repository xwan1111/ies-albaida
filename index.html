<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ImageChat AI</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#0f172a;
    color:white;
    display:flex;
    height:100vh;
}
#sidebar{
    width:260px;
    background:#020617;
    border-right:1px solid #1e293b;
    display:flex;
    flex-direction:column;
}
#newChat{
    padding:15px;
    cursor:pointer;
    background:#111827;
    border-bottom:1px solid #1e293b;
}
.chatItem{
    padding:12px;
    border-bottom:1px solid #1e293b;
    display:flex;
    justify-content:space-between;
}
.chatItem span{ cursor:pointer; }
.chatItem:hover{ background:#1e293b; }
.deleteChat{ color:#ef4444; }

#main{
    flex:1;
    display:flex;
    flex-direction:column;
}
#messages{
    flex:1;
    overflow:auto;
    padding:20px;
}
.message{ margin-bottom:20px; }
.user{ text-align:right; }

.imgBox{
    position:relative;
    display:inline-block;
}
.imgBox img{
    max-width:100%;
    border-radius:10px;
    display:block;
}
.downloadBtn{
    position:absolute;
    top:8px;
    right:8px;
    background:rgba(0,0,0,0.6);
    border:none;
    color:white;
    padding:6px 8px;
    border-radius:6px;
    cursor:pointer;
}
.downloadBtn:hover{ background:black; }

.loading{
    font-size:14px;
    opacity:0.7;
}

footer{
    display:flex;
    padding:15px;
    border-top:1px solid #1e293b;
    background:#020617;
}
input{
    flex:1;
    padding:12px;
    border-radius:8px;
    border:none;
    outline:none;
}
button.send{
    margin-left:10px;
    padding:12px 18px;
    border:none;
    border-radius:8px;
    background:#2563eb;
    color:white;
    cursor:pointer;
}
button.send:hover{ background:#1d4ed8; }
</style>
</head>

<body>

<div id="sidebar">
    <div id="newChat">‚ûï Nuevo chat</div>
    <div id="chatList"></div>
</div>

<div id="main">
    <div id="messages"></div>
    <footer>
        <input id="prompt" placeholder="Describe la imagen que quieres generar...">
        <button class="send" onclick="send()">Enviar</button>
    </footer>
</div>

<script>
let chats = JSON.parse(localStorage.getItem("imageChats")||"[]");
let currentChat = null;

function save(){
    localStorage.setItem("imageChats", JSON.stringify(chats));
}

function renderChats(){
    const list=document.getElementById("chatList");
    list.innerHTML="";
    chats.forEach((c,i)=>{
        list.innerHTML+=`
        <div class="chatItem">
            <span onclick="openChat(${i})">${c.name}</span>
            <span class="deleteChat" onclick="deleteChat(${i})">üóë</span>
        </div>`;
    });
}

function newChat(){
    const chat={name:"Chat "+(chats.length+1),messages:[]};
    chats.unshift(chat);
    currentChat=0;
    save();
    renderChats();
    renderMessages();
}

function deleteChat(i){
    if(!confirm("¬øBorrar este chat?")) return;
    chats.splice(i,1);
    currentChat=null;
    save();
    renderChats();
    document.getElementById("messages").innerHTML="";
}

function openChat(i){
    currentChat=i;
    renderMessages();
}

function renderMessages(){
    const box=document.getElementById("messages");
    box.innerHTML="";
    if(currentChat===null) return;

    chats[currentChat].messages.forEach(m=>{
        if(m.type==="user"){
            box.innerHTML+=`<div class="message user"><b>T√∫:</b> ${m.text}</div>`;
        }else{
            if(m.loading){
                box.innerHTML+=`<div class="message loading">Generando imagen...</div>`;
            }else{
                box.innerHTML+=`
                <div class="message">
                    <div class="imgBox">
                        <img src="${m.url}" referrerpolicy="no-referrer">
                        <button class="downloadBtn" onclick="downloadImage('${m.url}')">‚¨á</button>
                    </div>
                </div>`;
            }
        }
    });

    box.scrollTop=box.scrollHeight;
}

async function downloadImage(url){
    try{
        const res = await fetch(url);
        const blob = await res.blob();
        const blobUrl = URL.createObjectURL(blob);

        const a=document.createElement("a");
        a.href=blobUrl;
        a.download="imagen.png";
        a.click();

        URL.revokeObjectURL(blobUrl);
    }catch(e){
        window.open(url,"_blank");
    }
}

function send(){
    if(currentChat===null) return;

    const input=document.getElementById("prompt");
    const text=input.value.trim();
    if(!text) return;

    chats[currentChat].messages.push({type:"user",text});
    input.value="";

    // mensaje temporal de carga
    chats[currentChat].messages.push({type:"bot",loading:true});
    renderMessages();

    // generar URL de imagen IA
    const url="https://image.pollinations.ai/prompt/"
        + encodeURIComponent(text + ", photorealistic, ultra detailed, cinematic lighting");

    // esperar un poco para que la imagen exista
    setTimeout(()=>{
        chats[currentChat].messages.pop();
        chats[currentChat].messages.push({type:"bot",url});
        save();
        renderMessages();
    },1200);
}

// ENTER ENV√çA MENSAJE
document.getElementById("prompt").addEventListener("keydown",function(e){
    if(e.key==="Enter"){
        e.preventDefault();
        send();
    }
});

document.getElementById("newChat").onclick=newChat;
renderChats();
</script>

</body>
</html>
